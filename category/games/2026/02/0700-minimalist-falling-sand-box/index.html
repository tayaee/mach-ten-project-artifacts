<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimalist Falling Sand Box</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: system-ui, sans-serif;
            color: #eee;
        }
        h1 {
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: 300;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tool-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .tool-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 10px currentColor;
        }
        .tool-btn[data-tool="sand"] { background: #e6c86e; color: #1a1a2e; }
        .tool-btn[data-tool="water"] { background: #4a90d9; color: #fff; }
        .tool-btn[data-tool="wall"] { background: #555; color: #fff; }
        .tool-btn[data-tool="eraser"] { background: #ff6b6b; color: #fff; }
        .tool-btn[data-tool="clear"] { background: #a55eea; color: #fff; }
        canvas {
            border: 2px solid #333;
            cursor: crosshair;
        }
        .info {
            margin-top: 15px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>Falling Sand Box</h1>
    <div class="controls">
        <button class="tool-btn active" data-tool="sand">Sand</button>
        <button class="tool-btn" data-tool="water">Water</button>
        <button class="tool-btn" data-tool="wall">Wall</button>
        <button class="tool-btn" data-tool="eraser">Eraser</button>
        <button class="tool-btn" data-tool="clear">Clear All</button>
    </div>
    <canvas id="canvas"></canvas>
    <p class="info">Left click to draw, right click to erase</p>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const CELL_SIZE = 4;
        const COLS = Math.floor(window.innerWidth * 0.9 / CELL_SIZE);
        const ROWS = Math.floor((window.innerHeight - 150) / CELL_SIZE);

        canvas.width = COLS * CELL_SIZE;
        canvas.height = ROWS * CELL_SIZE;

        const EMPTY = 0;
        const SAND = 1;
        const WATER = 2;
        const WALL = 3;

        const COLORS = {
            [EMPTY]: '#1a1a2e',
            [SAND]: '#e6c86e',
            [WATER]: '#4a90d9',
            [WALL]: '#555'
        };

        let grid = [];
        let currentTool = SAND;
        let isDrawing = false;
        let isErasing = false;

        function initGrid() {
            grid = [];
            for (let y = 0; y < ROWS; y++) {
                grid[y] = [];
                for (let x = 0; x < COLS; x++) {
                    grid[y][x] = EMPTY;
                }
            }
        }

        function inBounds(x, y) {
            return x >= 0 && x < COLS && y >= 0 && y < ROWS;
        }

        function isEmpty(x, y) {
            return inBounds(x, y) && grid[y][x] === EMPTY;
        }

        function isLiquid(x, y) {
            return inBounds(x, y) && grid[y][x] === WATER;
        }

        function swap(x1, y1, x2, y2) {
            const temp = grid[y1][x1];
            grid[y1][x1] = grid[y2][x2];
            grid[y2][x2] = temp;
        }

        function updateSand(x, y) {
            if (isEmpty(x, y + 1)) {
                swap(x, y, x, y + 1);
            } else if (isLiquid(x, y + 1)) {
                swap(x, y, x, y + 1);
            } else if (isEmpty(x - 1, y + 1) && isEmpty(x + 1, y + 1)) {
                const dir = Math.random() < 0.5 ? -1 : 1;
                swap(x, y, x + dir, y + 1);
            } else if (isEmpty(x - 1, y + 1)) {
                swap(x, y, x - 1, y + 1);
            } else if (isEmpty(x + 1, y + 1)) {
                swap(x, y, x + 1, y + 1);
            }
        }

        function updateWater(x, y) {
            if (isEmpty(x, y + 1)) {
                swap(x, y, x, y + 1);
            } else if (isEmpty(x - 1, y + 1) && isEmpty(x + 1, y + 1)) {
                const dir = Math.random() < 0.5 ? -1 : 1;
                swap(x, y, x + dir, y + 1);
            } else if (isEmpty(x - 1, y + 1)) {
                swap(x, y, x - 1, y + 1);
            } else if (isEmpty(x + 1, y + 1)) {
                swap(x, y, x + 1, y + 1);
            } else {
                const dir = Math.random() < 0.5 ? -1 : 1;
                let spread = 0;
                while (spread < 10) {
                    if (isEmpty(x + dir * spread, y)) {
                        swap(x, y, x + dir * spread, y);
                        return;
                    }
                    spread++;
                }
            }
        }

        function update() {
            for (let y = ROWS - 1; y >= 0; y--) {
                const leftToRight = Math.random() < 0.5;
                for (let i = 0; i < COLS; i++) {
                    const x = leftToRight ? i : COLS - 1 - i;
                    const cell = grid[y][x];
                    if (cell === SAND) {
                        updateSand(x, y);
                    } else if (cell === WATER) {
                        updateWater(x, y);
                    }
                }
            }
        }

        function draw() {
            ctx.fillStyle = COLORS[EMPTY];
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (grid[y][x] !== EMPTY) {
                        ctx.fillStyle = COLORS[grid[y][x]];
                        ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        }

        function paint(cx, cy) {
            const x = Math.floor(cx / CELL_SIZE);
            const y = Math.floor(cy / CELL_SIZE);

            const radius = currentTool === WALL ? 1 : 3;

            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    if (dx * dx + dy * dy <= radius * radius) {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (inBounds(nx, ny)) {
                            if (isErasing) {
                                grid[ny][nx] = EMPTY;
                            } else if (grid[ny][nx] === EMPTY || currentTool === WALL) {
                                grid[ny][nx] = currentTool;
                            }
                        }
                    }
                }
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (e.button === 2) {
                isErasing = true;
            } else {
                isDrawing = true;
            }
            const rect = canvas.getBoundingClientRect();
            paint(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            isErasing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
            isErasing = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing && !isErasing) return;
            const rect = canvas.getBoundingClientRect();
            paint(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tool = btn.dataset.tool;
                if (tool === 'clear') {
                    initGrid();
                } else {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTool = tool === 'sand' ? SAND : tool === 'water' ? WATER : WALL;
                }
            });
        });

        initGrid();
        gameLoop();
    </script>
</body>
</html>
